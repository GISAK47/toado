<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªü Quy ho·∫°ch - Ki·∫øn Tr√∫c TPHCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-blue-700 mb-6 border-b pb-3">
            Trung T√¢m Th√¥ng Tin Quy Ho·∫°ch TPHCM
        </h1>
        <p class="text-gray-600 mb-6">
            C√≤n th·ªü l√† c√≤n g·ª° 
        </p>

        <div class="space-y-4 mb-8">
            <label for="fileInput" class="block text-lg font-medium text-gray-700">1. Ch·ªçn ·∫¢nh T·ªça ƒê·ªô (Ch·ªçn nhi·ªÅu file ho·∫∑c D√ÅN)</label>
            <input type="file" id="fileInput" accept="image/*" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150">
        </div>

        <button id="processButton" onclick="processMultipleImages()" class="w-full py-3 px-6 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50" disabled>
            <span id="buttonText">ü§ñ Ph√¢n T√≠ch ·∫¢nh v√† Tr√≠ch Xu·∫•t T·ªça ƒê·ªô</span>
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
        
        <div id="statusMessage" class="mt-4 text-center text-sm text-gray-500 hidden"></div>

        <div id="resultContainer" class="mt-8 pt-4 border-t hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">2. T·ªça ƒê·ªô ƒê√£ L√†m S·∫°ch (S·∫µn s√†ng v·∫Ω Nhi·ªÅu Ranh)</h2>
            <textarea id="outputCoords" rows="10" class="w-full p-4 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 text-gray-800 font-mono text-sm focus:ring-blue-500 focus:border-blue-500" readonly placeholder="K·∫øt qu·∫£ t·ªça ƒë·ªô (X Y m·ªói d√≤ng, c√°c ranh ngƒÉn c√°ch b·∫±ng 2 d√≤ng tr·ªëng) s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y..."></textarea>
            
            <button id="copyButton" onclick="copyToClipboard()" class="mt-4 py-2 px-6 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25H2.25a.75.75 0 0 1-.75-.75V8.25a.75.75 0 0 1 .75-.75h2.25V5.25a.75.75 0 0 1 .75-.75h10.5c.414 0 .75.336.75.75v12a.75.75 0 0 1-.75.75zM8.25 4.5V2.25a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 .75.75v2.25"></path>
                </svg>
                Copy T·ªça ƒê·ªô v√†o Clipboard
            </button>
        </div>

        <div id="errorBox" class="mt-4 p-4 text-red-700 bg-red-100 border border-red-400 rounded-lg hidden"></div>
    </div>

    <script>
        // ====================================================================
        
        // Kh√≥a API c·ªßa b·∫°n:
        const apiKey = "AIzaSyB3TIzWE-t_JBg-ovVvB6O7t95xXKmSbgM"; 
        // ====================================================================
        
        // C·∫•u h√¨nh API v√† Endpoint
        const MODEL_NAME = "gemini-2.5-flash";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // Elements
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const outputCoords = document.getElementById('outputCoords');
        const resultContainer = document.getElementById('resultContainer');
        const errorBox = document.getElementById('errorBox');
        const statusMessage = document.getElementById('statusMessage');

        // ====================================================================
        // T√çNH NƒÇNG: D√°n ·∫£nh t·ª´ Clipboard
        // ====================================================================

        document.addEventListener('paste', handlePasteImage);

        function handlePasteImage(event) {
            hideError();
            
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let imageFile = null;

            for (const item of items) {
                // Ki·ªÉm tra xem item c√≥ ph·∫£i l√† h√¨nh ·∫£nh v√† l√† File kh√¥ng
                if (item.type.indexOf('image') !== -1 && item.kind === 'file') {
                    // C·ªë g·∫Øng ƒë·∫∑t t√™n file t·ª± ƒë·ªông (v√≠ d·ª•: clipboard_image_timestamp.png)
                    const now = new Date();
                    const fileName = `Clipboard_Image_${now.getHours()}${now.getMinutes()}${now.getSeconds()}.png`;
                    imageFile = new File([item.getAsFile()], fileName, {type: item.type});
                    break;
                }
            }

            if (imageFile) {
                event.preventDefault(); 

                // 1. L·∫•y danh s√°ch file hi·ªán c√≥
                const currentFiles = fileInput.files;

                // 2. T·∫°o ƒë·ªëi t∆∞·ª£ng DataTransfer m·ªõi
                const dataTransfer = new DataTransfer();

                // 3. TH√äM c√°c file c≈© (n·∫øu c√≥)
                if (currentFiles) {
                    for (let i = 0; i < currentFiles.length; i++) {
                        dataTransfer.items.add(currentFiles[i]);
                    }
                }
                
                // 4. TH√äM file ·∫£nh m·ªõi d√°n
                dataTransfer.items.add(imageFile);

                // 5. C·∫≠p nh·∫≠t l·∫°i fileInput.files v·ªõi danh s√°ch m·ªõi
                fileInput.files = dataTransfer.files;

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i button
                processButton.disabled = false;
                resultContainer.classList.add('hidden');
                outputCoords.value = "";
                
                // Hi·ªÉn th·ªã th√¥ng b√°o t·ªïng s·ªë file hi·ªán c√≥
                showStatusMessage(`‚úÖ ƒê√£ d√°n ·∫£nh t·ª´ Clipboard. T·ªïng s·ªë file s·∫µn s√†ng x·ª≠ l√Ω: ${fileInput.files.length}`, 'green');
            }
        }

        // B·∫≠t n√∫t x·ª≠ l√Ω khi c√≥ file ƒë∆∞·ª£c ch·ªçn ho·∫∑c khi fileInput.files ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ paste
        fileInput.addEventListener('change', () => {
            processButton.disabled = fileInput.files.length === 0;
            resultContainer.classList.add('hidden');
            errorBox.classList.add('hidden');
            statusMessage.classList.add('hidden'); // ·∫®n tr·∫°ng th√°i d√°n khi ch·ªçn file m·ªõi
            outputCoords.value = "";
        });

        // H√†m ch√≠nh x·ª≠ l√Ω NHI·ªÄU ·∫£nh v√† g·ªçi API
        async function processMultipleImages() {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                displayError("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file ·∫£nh ho·∫∑c d√°n ·∫£nh t·ª´ clipboard.");
                return;
            }

            setLoading(true, `ƒêang x·ª≠ l√Ω 1/${files.length} file...`);
            hideError();
            resultContainer.classList.add('hidden');
            
            const allOutputCoords = [];
            let successfulCount = 0;

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = file.name || `·∫£nh d√°n ${i + 1}`; // T√™n file cho ·∫£nh d√°n

                    setLoading(true, `ƒêang x·ª≠ l√Ω ${i + 1}/${files.length} file: ${fileName}`);
                    
                    const base64Data = await readFileAsBase64(file);
                    
                    // G·ªçi API cho t·ª´ng ·∫£nh
                    const coordsArray = await callGeminiAPI(base64Data, file.type);
                    
                    if (coordsArray.length === 0) {
                        console.warn(`[C·∫¢NH B√ÅO] AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t t·ªça ƒë·ªô h·ª£p l·ªá t·ª´ file: ${fileName}. B·ªè qua file n√†y.`);
                        continue;
                    }
                    
                    // Th√™m k·∫øt qu·∫£ v√†o danh s√°ch
                    allOutputCoords.push(formatCoordsForOutput(coordsArray));
                    successfulCount++;
                }

                if (successfulCount === 0) {
                    displayError("AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë∆∞·ª£c t·ªça ƒë·ªô h·ª£p l·ªá t·ª´ b·∫•t k·ª≥ ·∫£nh n√†o ƒë√£ ch·ªçn. Vui l√≤ng ki·ªÉm tra l·∫°i ch·∫•t l∆∞·ª£ng ·∫£nh.");
                    return;
                }
                
                // N·ªëi t·∫•t c·∫£ c√°c ranh gi·ªõi l·∫°i, c√°ch nhau b·ªüi 2 d√≤ng tr·ªëng
                const finalOutput = allOutputCoords.join('\n\n');
                
                displayResults(finalOutput);

            } catch (error) {
                console.error("L·ªói x·ª≠ l√Ω:", error);
                if (error.message.includes("403")) {
                    displayError(`L·ªói 403 FORBIDDEN: Kh√≥a API c·ªßa b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng ki·ªÉm tra l·∫°i H·∫°n ch·∫ø Kh√≥a API tr√™n Google AI Studio, ƒë·∫£m b·∫£o kh√≥a ƒëang ·ªü ch·∫ø ƒë·ªô "Kh√¥ng gi·ªõi h·∫°n" (None) khi ch·∫°y c·ª•c b·ªô.`);
                } else {
                    displayError(`L·ªói x·ª≠ l√Ω API ho·∫∑c d·ªØ li·ªáu: ${error.message}`);
                }
            } finally {
                setLoading(false);
            }
        }

        // ƒê·ªçc file ·∫£nh v√† chuy·ªÉn th√†nh Base64
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // G·ªçi API Gemini
        async function callGeminiAPI(base64Data, mimeType) {
            const systemPrompt = "B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch d·ªØ li·ªáu tr·∫Øc ƒë·ªãa. Nhi·ªám v·ª• c·ªßa b·∫°n l√† tr√≠ch xu·∫•t ch√≠nh x√°c t·∫•t c·∫£ c√°c c·∫∑p t·ªça ƒë·ªô X (Kinh Tuy·∫øn) v√† Y (Vƒ© Tuy·∫øn) t·ª´ ·∫£nh b·∫£ng t·ªça ƒë·ªô ƒë∆∞·ª£c cung c·∫•p. B·ªè qua c·ªôt STT v√† cao ƒë·ªô (Z/H) n·∫øu c√≥. Ch·ªâ tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON tu√¢n th·ªß schema ƒë√£ cho.";
            
            // Schema JSON mong mu·ªën
            const responseSchema = {
                type: "ARRAY",
                description: "M·∫£ng ch·ª©a c√°c ƒë·ªëi t∆∞·ª£ng t·ªça ƒë·ªô X v√† Y.",
                items: {
                    type: "OBJECT",
                    properties: {
                        "x": { "type": "number", "description": "T·ªça ƒë·ªô X (Kinh Tuy·∫øn, th∆∞·ªùng l√† s·ªë l·ªõn h∆°n)." },
                        "y": { "type": "number", "description": "T·ªça ƒë·ªô Y (Vƒ© Tuy·∫øn, th∆∞·ªùng l√† s·ªë nh·ªè h∆°n)." }
                    },
                    required: ["x", "y"],
                    "propertyOrdering": ["x", "y"]
                }
            };

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Tr√≠ch xu·∫•t t·ªça ƒë·ªô X v√† Y t·ª´ b·∫£ng n√†y. ƒê·∫£m b·∫£o m·ªçi gi√° tr·ªã th·∫≠p ph√¢n ƒë·ªÅu ƒë∆∞·ª£c tr·∫£ v·ªÅ d∆∞·ªõi d·∫°ng s·ªë (Number) trong JSON. Ch·ªâ tr·∫£ v·ªÅ m·∫£ng JSON, kh√¥ng th√™m vƒÉn b·∫£n gi·∫£i th√≠ch." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };
            
            let lastError = null;
            const maxRetries = 1; 
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                let response = null; 
                const delay = Math.pow(2, attempt) * 1000; 

                if (attempt > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }

                try {
                    statusMessage.classList.add('hidden');

                    response = await fetch(apiUrl, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 403 || response.status === 429 || response.status >= 500) {
                            lastError = new Error(`L·ªói HTTP ${response.status}: ${errorData.error?.message || 'Kh√¥ng r√µ.'}`);
                            continue;
                        }
                        throw new Error(`L·ªói HTTP ${response.status}: ${errorData.error?.message || 'Kh√¥ng r√µ.'}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const jsonText = result.candidates[0].content.parts[0].text.trim();
                        const cleanedJsonText = jsonText.replace(/```json|```/g, '').trim();
                        
                        return JSON.parse(cleanedJsonText);
                    } else {
                        throw new Error("C·∫•u tr√∫c ph·∫£n h·ªìi AI kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu n·ªôi dung.");
                    }
                } catch (error) {
                    lastError = error;
                    if (response && (response.status === 403 || response.status === 429 || response.status >= 500)) { 
                        continue; 
                    } else {
                        throw error; 
                    }
                }
            }
            throw lastError;
        }

        // ƒê·ªãnh d·∫°ng m·∫£ng t·ªça ƒë·ªô th√†nh chu·ªói X Y c√°ch nhau 1 d√≤ng
        function formatCoordsForOutput(coordsArray) {
            let output = "";
            coordsArray.forEach(coord => {
                output += `${coord.x} ${coord.y}\n`;
            });
            return output.trim(); // Lo·∫°i b·ªè d√≤ng tr·ªëng cu·ªëi c√πng
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ cu·ªëi c√πng
        function displayResults(finalOutput) {
            outputCoords.value = finalOutput;
            resultContainer.classList.remove('hidden');
            statusMessage.classList.add('hidden');
        }

        // Copy n·ªôi dung v√†o clipboard
        function copyToClipboard() {
            outputCoords.select();
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(outputCoords.value).then(() => {
                        showSuccessMessage("ƒê√£ Copy T·ªça ƒê·ªô v√†o Clipboard!");
                    }).catch(err => {
                        console.error('L·ªói khi Copy:', err);
                        showSuccessMessage("Vui l√≤ng Copy th·ªß c√¥ng: Ch·ªçn v√† Ctrl+C.");
                    });
                } else {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showSuccessMessage("ƒê√£ Copy T·ªça ƒê·ªô v√†o Clipboard!");
                    } else {
                        throw new Error("Copy kh√¥ng th√†nh c√¥ng.");
                    }
                }
            } catch (err) {
                console.error('Kh√¥ng th·ªÉ copy', err);
                showSuccessMessage("Vui l√≤ng Copy th·ªß c√¥ng: Ch·ªçn v√† Ctrl+C.");
            }
        }

        // Utility Functions
        function setLoading(isLoading, message = "ü§ñ Ph√¢n T√≠ch ·∫¢nh v√† Tr√≠ch Xu·∫•t T·ªça ƒê·ªô") {
            processButton.disabled = isLoading || fileInput.files.length === 0;
            spinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? message : "ü§ñ Ph√¢n T√≠ch ·∫¢nh v√† Tr√≠ch Xu·∫•t T·ªça ƒê·ªô";
            if (isLoading) {
                statusMessage.classList.add('hidden'); // ·∫®n tr·∫°ng th√°i d√°n khi b·∫Øt ƒë·∫ßu x·ª≠ l√Ω
            }
        }

        function displayError(message) {
            errorBox.textContent = `L·ªói: ${message}`;
            errorBox.classList.remove('hidden');
            statusMessage.classList.add('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i (d√†nh cho t√≠nh nƒÉng D√°n)
        function showStatusMessage(message, color) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 text-center text-sm ${color === 'green' ? 'text-green-600 bg-green-50' : 'text-gray-500'} p-2 rounded`;
            statusMessage.classList.remove('hidden');
        }

        function showSuccessMessage(message) {
            const originalText = document.getElementById('copyButton').innerHTML;
            const copyButton = document.getElementById('copyButton');
            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"></path></svg> ${message}`;
            copyButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            copyButton.classList.add('bg-green-500', 'hover:bg-green-600');

            setTimeout(() => {
                copyButton.innerHTML = originalText;
                copyButton.classList.add('bg-red-500', 'hover:bg-red-600');
                copyButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            }, 2000);
        }
    </script>
</body>
</html>